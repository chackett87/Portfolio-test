//This code looks horrible, re-do it all